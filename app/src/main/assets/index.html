<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üé≠ Mafia Game</title>
    <style>
        /* –û–¢–ö–õ–Æ–ß–ï–ù–ò–ï PULL-TO-REFRESH */
        html, body {
            overscroll-behavior: none;
            -webkit-overflow-scrolling: touch;
            touch-action: pan-x pan-y;
            user-select: none;
            -webkit-user-select: none;
            -webkit-touch-callout: none;
        }

        /* –û—Ç–∫–ª—é—á–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é */
        * {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -webkit-touch-callout: none;
            -webkit-tap-highlight-color: transparent;
        }

        /* –†–∞–∑—Ä–µ—à–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ –≤ –ø–æ–ª—è—Ö –≤–≤–æ–¥–∞ */
        input, textarea {
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
            user-select: text;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 3em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            padding: 25px;
            margin: 20px 0;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
        }

        .hidden {
            display: none !important;
        }

        /* –°—Ç–∞—Ç—É—Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è */
        .connection-status {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 10px 15px;
            border-radius: 20px;
            color: white;
            font-weight: bold;
            z-index: 1000;
            font-size: 0.9em;
        }

        .status-connecting {
            background: #f39c12;
        }

        .status-connected {
            background: #27ae60;
        }

        .status-disconnected {
            background: #e74c3c;
        }

        .status-error {
            background: #8e44ad;
        }

        /* –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è */
        .auth-form {
            max-width: 400px;
            margin: 0 auto;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #667eea;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        .form-group input:focus {
            border-color: #667eea;
            outline: none;
        }

        .btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            margin: 5px;
            transition: all 0.3s ease;
            width: 100%;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #95a5a6, #7f8c8d);
        }

        .btn-danger {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
        }

        .btn-success {
            background: linear-gradient(135deg, #27ae60, #229954);
        }

        /* –õ–æ–±–±–∏ */
        .rooms-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .room-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
            border-left: 4px solid #667eea;
            cursor: pointer;
        }

        .room-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .room-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .room-name {
            font-size: 1.2em;
            font-weight: bold;
            color: #667eea;
        }

        .room-status {
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8em;
            font-weight: bold;
        }

        .status-waiting {
            background: #27ae60;
            color: white;
        }

        .status-playing {
            background: #e74c3c;
            color: white;
        }

        .room-info {
            margin-bottom: 15px;
        }

        .room-players {
            color: #666;
            margin-bottom: 5px;
        }

        .room-creator {
            color: #667eea;
            font-weight: bold;
        }

        /* –ò–≥—Ä–æ–≤–∞—è –∫–æ–º–Ω–∞—Ç–∞ */
        .game-room {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 20px;
            height: 85vh;
        }

        .game-main {
            display: flex;
            flex-direction: column;
        }

        .game-header {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }

        .game-phase {
            font-size: 1.5em;
            margin-bottom: 10px;
        }

        .game-timer {
            font-size: 2em;
            font-weight: bold;
        }

        .players-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            flex: 1;
            margin-bottom: 20px;
        }

        .player-card {
            background: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .player-card:hover {
            transform: scale(1.05);
        }

        .player-card.dead {
            opacity: 0.5;
            background: #f8f9fa;
        }

        .player-card.selected {
            border: 3px solid #667eea;
            background: #e8f0fe;
        }

        .player-avatar {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .player-nickname {
            font-weight: bold;
            margin-bottom: 5px;
            cursor: pointer;
        }

        .player-nickname:hover {
            color: #667eea;
        }

        .player-role {
            font-size: 0.8em;
            color: #666;
            background: #f0f0f0;
            padding: 2px 8px;
            border-radius: 10px;
        }

        .player-status {
            margin-top: 5px;
            font-size: 0.8em;
        }

        .status-alive {
            color: #27ae60;
        }

        .status-dead {
            color: #e74c3c;
        }

        /* –ß–∞—Ç */
        .chat-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            max-height: 85vh;
        }

        .chat-messages {
            flex: 1;
            background: white;
            border-radius: 10px;
            padding: 15px;
            overflow-y: auto;
            margin-bottom: 15px;
            max-height: 60vh;
            min-height: 300px;
        }

        .message {
            margin-bottom: 10px;
            padding: 8px 12px;
            border-radius: 8px;
            background: #f8f9fa;
        }

        .message.system {
            background: #e3f2fd;
            color: #1976d2;
            font-style: italic;
        }

        .message-sender {
            font-weight: bold;
            color: #667eea;
            margin-right: 8px;
        }

        .message-time {
            font-size: 0.8em;
            color: #999;
            float: right;
        }

        .chat-input {
            display: flex;
            gap: 10px;
        }

        .chat-input input {
            flex: 1;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
        }

        .chat-input input:focus {
            border-color: #667eea;
            outline: none;
        }

        /* –ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è */
        .user-profile {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }

        .user-avatar {
            font-size: 3em;
            margin-bottom: 10px;
        }

        .user-nickname {
            font-size: 1.5em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 10px;
        }

        .user-coins {
            font-size: 1.2em;
            color: #f39c12;
            margin-bottom: 10px;
        }

        .user-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }

        .stat-item {
            text-align: center;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .stat-value {
            font-size: 1.5em;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            font-size: 0.8em;
            color: #666;
        }

        /* –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #27ae60;
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 1000;
            animation: slideIn 0.3s ease-out;
            max-width: 300px;
        }

        .notification.error {
            background: #e74c3c;
        }

        .notification.warning {
            background: #f39c12;
        }

        .notification.info {
            background: #3498db;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
        @media (max-width: 768px) {
            .game-room {
                grid-template-columns: 1fr;
                height: auto;
            }

            .players-grid {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            }

            .header h1 {
                font-size: 2em;
            }

            .container {
                padding: 10px;
            }

            .chat-container {
                max-height: 50vh;
            }

            .chat-messages {
                max-height: 30vh;
            }

            .connection-status {
                top: 5px;
                right: 5px;
                padding: 8px 12px;
                font-size: 0.8em;
            }
        }

        /* –õ–æ–∞–¥–µ—Ä */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .debug-info {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            margin-top: 20px;
            max-height: 200px;
            overflow-y: auto;
        }

        .debug-info h4 {
            color: #3498db;
            margin-bottom: 10px;
        }

        /* –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ª–æ–±–±–∏ */
        .lobby-stats {
            margin-bottom: 20px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-icon {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .admin-badge {
            background: linear-gradient(45deg, #ffd700, #ffed4e);
            color: #333;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.8em;
            font-weight: bold;
            margin-left: 5px;
        }
    </style>
</head>
<body>
    <!-- –°—Ç–∞—Ç—É—Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è -->
    <div id="connectionStatus" class="connection-status status-connecting">
        üîå –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...
    </div>

    <div class="container">
        <div class="header">
            <h1>üé≠ Mafia Game</h1>
            <p>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –º–∏—Ä –∏–Ω—Ç—Ä–∏–≥ –∏ –æ–±–º–∞–Ω–∞</p>
        </div>

        <!-- –≠–∫—Ä–∞–Ω –∑–∞–≥—Ä—É–∑–∫–∏ -->
        <div id="loadingScreen" class="card">
            <div style="text-align: center;">
                <div class="loader"></div>
                <h2>–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É...</h2>
                <p id="loadingMessage">–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...</p>
                
                <div class="debug-info">
                    <h4>üîß –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:</h4>
                    <div id="debugInfo">
                        <div>üåê URL: <span id="debugUrl">-</span></div>
                        <div>üîå WebSocket: <span id="debugWS">-</span></div>
                        <div>üìä –ü–æ–ø—ã—Ç–∫–∞: <span id="debugAttempt">1</span></div>
                        <div>‚è∞ –í—Ä–µ–º—è: <span id="debugTime">-</span></div>
                        <div>‚ùå –û—à–∏–±–∫–∞: <span id="debugError">-</span></div>
                    </div>
                </div>

                <button class="btn btn-secondary" onclick="forceReconnect()" style="margin-top: 15px;">
                    üîÑ –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è
                </button>
            </div>
        </div>

        <!-- –≠–∫—Ä–∞–Ω –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ -->
        <div id="authScreen" class="card hidden">
            <div class="auth-form">
                <h2 style="text-align: center; color: #667eea; margin-bottom: 30px;">–í—Ö–æ–¥ –≤ –∏–≥—Ä—É</h2>
                
                <div id="loginForm">
                    <div class="form-group">
                        <label for="loginNickname">–ù–∏–∫–Ω–µ–π–º:</label>
                        <input type="text" id="loginNickname" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –Ω–∏–∫–Ω–µ–π–º" maxlength="20">
                    </div>
                    <div class="form-group">
                        <label for="loginPassword">–ü–∞—Ä–æ–ª—å:</label>
                        <input type="password" id="loginPassword" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å">
                    </div>
                    <button class="btn" onclick="login()" id="loginBtn">–í–æ–π—Ç–∏</button>
                    <button class="btn btn-secondary" onclick="showRegisterForm()">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
                </div>

                <div id="registerForm" class="hidden">
                    <div class="form-group">
                        <label for="registerNickname">–ù–∏–∫–Ω–µ–π–º:</label>
                        <input type="text" id="registerNickname" placeholder="–ü—Ä–∏–¥—É–º–∞–π—Ç–µ –Ω–∏–∫–Ω–µ–π–º (3-15 —Å–∏–º–≤–æ–ª–æ–≤)" maxlength="15">
                    </div>
                    <div class="form-group">
                        <label for="registerPassword">–ü–∞—Ä–æ–ª—å:</label>
                        <input type="password" id="registerPassword" placeholder="–ü—Ä–∏–¥—É–º–∞–π—Ç–µ –ø–∞—Ä–æ–ª—å (4-20 —Å–∏–º–≤–æ–ª–æ–≤)" maxlength="20">
                    </div>
                    <div class="form-group">
                        <label for="registerAvatar">–ê–≤–∞—Ç–∞—Ä:</label>
                        <input type="text" id="registerAvatar" placeholder="–í—ã–±–µ—Ä–∏—Ç–µ —ç–º–æ–¥–∑–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä: üòé)" maxlength="2">
                    </div>
                    <button class="btn" onclick="register()" id="registerBtn">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
                    <button class="btn btn-secondary" onclick="showLoginForm()">–ù–∞–∑–∞–¥ –∫ –≤—Ö–æ–¥—É</button>
                </div>
            </div>
        </div>

        <!-- –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é -->
        <div id="mainMenu" class="hidden">
            <!-- –ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
            <div class="user-profile">
                <div class="user-avatar" id="userAvatar">üë§</div>
                <div class="user-nickname" id="userNickname">–ò–≥—Ä–æ–∫</div>
                <div class="user-coins" id="userCoins">üí∞ 0 –º–æ–Ω–µ—Ç</div>
                <div class="user-stats">
                    <div class="stat-item">
                        <div class="stat-value" id="userGamesPlayed">0</div>
                        <div class="stat-label">–ò–≥—Ä —Å—ã–≥—Ä–∞–Ω–æ</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="userGamesWon">0</div>
                        <div class="stat-label">–ü–æ–±–µ–¥</div>
                    </div>
                </div>
                <div style="margin-top: 15px;">
                    <button class="btn btn-secondary" onclick="showShop()">üõí –ú–∞–≥–∞–∑–∏–Ω</button>
                    <button class="btn btn-secondary" onclick="showSettings()">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
                    <button class="btn btn-danger" onclick="logout()">üö™ –í—ã–π—Ç–∏</button>
                </div>
            </div>

            <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ -->
            <div class="lobby-stats card">
                <h3 style="color: #667eea; margin-bottom: 15px;">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞</h3>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">üë•</div>
                        <div class="stat-value" id="onlineUsers">0</div>
                        <div class="stat-label">–û–Ω–ª–∞–π–Ω</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üè†</div>
                        <div class="stat-value" id="activeRooms">0</div>
                        <div class="stat-label">–ö–æ–º–Ω–∞—Ç</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üéÆ</div>
                        <div class="stat-value" id="activeGames">0</div>
                        <div class="stat-label">–ò–≥—Ä</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">‚è∞</div>
                        <div class="stat-value" id="serverUptime">0</div>
                        <div class="stat-label">–ß–∞—Å–æ–≤ —Ä–∞–±–æ—Ç—ã</div>
                    </div>
                </div>
            </div>

            <!-- –°–ø–∏—Å–æ–∫ –∫–æ–º–Ω–∞—Ç -->
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>üè† –ò–≥—Ä–æ–≤—ã–µ –∫–æ–º–Ω–∞—Ç—ã</h2>
                    <button class="btn" onclick="showCreateRoomForm()">‚ûï –°–æ–∑–¥–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É</button>
                </div>
                <div id="roomsList" class="rooms-grid">
                    <!-- –ö–æ–º–Ω–∞—Ç—ã –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                </div>
            </div>
        </div>

        <!-- –§–æ—Ä–º–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–º–Ω–∞—Ç—ã -->
        <div id="createRoomForm" class="card hidden">
            <h2 style="color: #667eea; margin-bottom: 20px;">–°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π –∫–æ–º–Ω–∞—Ç—ã</h2>
            <div class="form-group">
                <label for="roomName">–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–Ω–∞—Ç—ã:</label>
                <input type="text" id="roomName" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–Ω–∞—Ç—ã" maxlength="30">
            </div>
            <div class="form-group">
                <label for="roomPassword">–ü–∞—Ä–æ–ª—å (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ):</label>
                <input type="password" id="roomPassword" placeholder="–û—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–æ–π –∫–æ–º–Ω–∞—Ç—ã">
            </div>
            <div class="form-group">
                <label for="minPlayers">–ú–∏–Ω–∏–º—É–º –∏–≥—Ä–æ–∫–æ–≤:</label>
                <select id="minPlayers">
                    <option value="4">4 –∏–≥—Ä–æ–∫–∞</option>
                    <option value="5">5 –∏–≥—Ä–æ–∫–æ–≤</option>
                    <option value="6">6 –∏–≥—Ä–æ–∫–æ–≤</option>
                </select>
            </div>
            <div class="form-group">
                <label for="maxPlayers">–ú–∞–∫—Å–∏–º—É–º –∏–≥—Ä–æ–∫–æ–≤:</label>
                <select id="maxPlayers">
                    <option value="8">8 –∏–≥—Ä–æ–∫–æ–≤</option>
                    <option value="10" selected>10 –∏–≥—Ä–æ–∫–æ–≤</option>
                    <option value="12">12 –∏–≥—Ä–æ–∫–æ–≤</option>
                </select>
            </div>
            <div class="form-group">
                <label>–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–æ–ª–∏:</label>
                <div style="margin-top: 10px;">
                    <label style="display: flex; align-items: center; margin-bottom: 5px;">
                        <input type="checkbox" id="doctorRole" checked style="margin-right: 10px;">
                        üë®‚Äç‚öïÔ∏è –î–æ–∫—Ç–æ—Ä
                    </label>
                    <label style="display: flex; align-items: center;">
                        <input type="checkbox" id="loversRole" style="margin-right: 10px;">
                        üíï –í–ª—é–±–ª—ë–Ω–Ω—ã–µ
                    </label>
                </div>
            </div>
            <div style="display: flex; gap: 10px;">
                <button class="btn" onclick="createRoom()">–°–æ–∑–¥–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É</button>
                <button class="btn btn-secondary" onclick="hideCreateRoomForm()">–û—Ç–º–µ–Ω–∞</button>
            </div>
        </div>

        <!-- –ò–≥—Ä–æ–≤–∞—è –∫–æ–º–Ω–∞—Ç–∞ -->
        <div id="gameRoom" class="hidden">
            <div class="game-room">
                <div class="game-main">
                    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∏–≥—Ä—ã -->
                    <div class="game-header">
                        <div class="game-phase" id="gamePhase">–û–∂–∏–¥–∞–Ω–∏–µ –∏–≥—Ä–æ–∫–æ–≤...</div>
                        <div class="game-timer" id="gameTimer">--:--</div>
                        <div id="gameRole" style="margin-top: 10px; font-size: 1.2em;"></div>
                    </div>

                    <!-- –°–µ—Ç–∫–∞ –∏–≥—Ä–æ–∫–æ–≤ -->
                    <div class="players-grid" id="playersGrid">
                        <!-- –ò–≥—Ä–æ–∫–∏ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                    </div>

                    <!-- –ò–≥—Ä–æ–≤—ã–µ –¥–µ–π—Å—Ç–≤–∏—è -->
                    <div id="gameActions" class="card hidden">
                        <h3 id="actionTitle">–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ</h3>
                        <div id="actionButtons" style="display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap;">
                            <!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                        </div>
                    </div>
                </div>

                <!-- –ß–∞—Ç -->
                <div class="chat-container">
                    <div class="card" style="flex: 1; display: flex; flex-direction: column;">
                        <h3 style="margin-bottom: 15px; color: #667eea;">üí¨ –ß–∞—Ç</h3>
                        <div class="chat-messages" id="chatMessages">
                            <!-- –°–æ–æ–±—â–µ–Ω–∏—è –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                        </div>
                        <div class="chat-input">
                            <input type="text" id="chatInput" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." maxlength="200">
                            <button class="btn" onclick="sendMessage()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                        </div>
                    </div>
                    
                    <!-- –ö–Ω–æ–ø–∫–∞ –≤—ã—Ö–æ–¥–∞ -->
                    <button class="btn btn-danger" onclick="leaveRoom()" style="margin-top: 15px;">üö™ –ü–æ–∫–∏–Ω—É—Ç—å –∫–æ–º–Ω–∞—Ç—É</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let ws = null;
        let currentUser = null;
        let currentRoom = null;
        let selectedPlayer = null;
        let gameState = null;
        let reconnectAttempts = 0;
        let maxReconnectAttempts = 10;
        let isConnecting = false;
        let connectionStatus = 'disconnected';
        let deviceId = null;
        let sessionId = null;

        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º WebSocket URL - –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò –ò–ó –¢–ï–ö–£–©–ï–ì–û –•–û–°–¢–ê
        function getWebSocketURL() {
    return 'wss://gitler.onrender.com/ws';
}

        // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è deviceId
        function generateDeviceId() {
            if (!deviceId) {
                deviceId = localStorage.getItem('mafia_device_id');
                if (!deviceId) {
                    deviceId = 'device_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                    localStorage.setItem('mafia_device_id', deviceId);
                }
            }
            return deviceId;
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–ª–∞–¥–æ—á–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
        function updateDebugInfo(key, value) {
            const element = document.getElementById(`debug${key.charAt(0).toUpperCase() + key.slice(1)}`);
            if (element) {
                element.textContent = value;
            }
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
        function updateConnectionStatus(status, message) {
            connectionStatus = status;
            const statusElement = document.getElementById('connectionStatus');
            const loadingMessage = document.getElementById('loadingMessage');
            
            statusElement.className = `connection-status status-${status}`;
            
            switch (status) {
                case 'connecting':
                    statusElement.textContent = 'üîå –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...';
                    if (loadingMessage) loadingMessage.textContent = message || '–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É...';
                    break;
                case 'connected':
                    statusElement.textContent = '‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ';
                    if (loadingMessage) loadingMessage.textContent = '–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ!';
                    break;
                case 'disconnected':
                    statusElement.textContent = '‚ùå –û—Ç–∫–ª—é—á–µ–Ω–æ';
                    if (loadingMessage) loadingMessage.textContent = message || '–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –ø–æ—Ç–µ—Ä—è–Ω–æ';
                    break;
                case 'error':
                    statusElement.textContent = '‚ö†Ô∏è –û—à–∏–±–∫–∞';
                    if (loadingMessage) loadingMessage.textContent = message || '–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è';
                    break;
            }
        }

        // –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ WebSocket
        function connectWebSocket() {
    console.log('üîå –ù–ê–ß–ò–ù–ê–ï–ú –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–ï WebSocket');
    
    // –ü—Ä–æ—Å—Ç–æ–π —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π URL
    const wsUrl = 'wss://gitler.onrender.com/ws';
    console.log('üîó –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫:', wsUrl);
    
    updateDebugInfo('url', wsUrl);
    updateDebugInfo('ws', '–°–æ–∑–¥–∞–µ–º...');
    updateConnectionStatus('connecting', '–°–æ–∑–¥–∞–Ω–∏–µ WebSocket...');
    
    try {
        // –ó–∞–∫—Ä—ã–≤–∞–µ–º —Å—Ç–∞—Ä–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
        if (ws) {
            ws.close();
            ws = null;
        }
        
        console.log('üî® –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π WebSocket...');
        ws = new WebSocket(wsUrl);
        
        console.log('‚úÖ WebSocket —Å–æ–∑–¥–∞–Ω, —Å–æ—Å—Ç–æ—è–Ω–∏–µ:', ws.readyState);
        updateDebugInfo('ws', `–°–æ–∑–¥–∞–Ω (${ws.readyState})`);
        
        ws.onopen = function(event) {
            console.log('üéâ WebSocket –û–¢–ö–†–´–¢!');
            updateDebugInfo('ws', '–û–¢–ö–†–´–¢');
            updateConnectionStatus('connected', '–ü–æ–¥–∫–ª—é—á–µ–Ω–æ!');
            showAuthScreen();
        };
        
        ws.onmessage = function(event) {
            console.log('üì® –°–æ–æ–±—â–µ–Ω–∏–µ:', event.data);
            try {
                const data = JSON.parse(event.data);
                handleWebSocketMessage(data);
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞:', error);
            }
        };
        
        ws.onclose = function(event) {
            console.log('üîå WebSocket –ó–ê–ö–†–´–¢. –ö–æ–¥:', event.code, '–ü—Ä–∏—á–∏–Ω–∞:', event.reason);
            updateDebugInfo('ws', `–ó–∞–∫—Ä—ã—Ç (${event.code})`);
            updateDebugInfo('error', `–ó–∞–∫—Ä—ã—Ç: ${event.reason || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}`);
            updateConnectionStatus('disconnected', `–ó–∞–∫—Ä—ã—Ç (${event.code})`);
        };
        
        ws.onerror = function(error) {
            console.error('‚ùå WebSocket –û–®–ò–ë–ö–ê:', error);
            updateDebugInfo('ws', '–û–®–ò–ë–ö–ê');
            updateDebugInfo('error', '–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è');
            updateConnectionStatus('error', '–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è');
        };
        
    } catch (error) {
        console.error('‚ùå –û–®–ò–ë–ö–ê —Å–æ–∑–¥–∞–Ω–∏—è WebSocket:', error);
        updateDebugInfo('ws', '–û–®–ò–ë–ö–ê –°–û–ó–î–ê–ù–ò–Ø');
        updateDebugInfo('error', error.message);
        updateConnectionStatus('error', '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è: ' + error.message);
    }
}

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
        function handleConnectionError(errorMessage) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:', errorMessage);
            updateDebugInfo('error', errorMessage);
            updateConnectionStatus('error', errorMessage);
            showNotification(errorMessage, 'error');
        }

        // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
        function forceReconnect() {
            console.log('üîÑ –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ');
            reconnectAttempts = 0;
            isConnecting = false;
            
            if (ws) {
                ws.close();
                ws = null;
            }
            
            updateDebugInfo('error', '–ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...');
            connectWebSocket();
        }

        // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
        function sendWebSocketMessage(data) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                try {
                    const message = JSON.stringify(data);
                    ws.send(message);
                    console.log('üì§ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ:', data.type);
                    return true;
                } catch (error) {
                    console.error('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏:', error);
                    showNotification('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è', 'error');
                    return false;
                }
            } else {
                console.error('‚ùå WebSocket –Ω–µ –≥–æ—Ç–æ–≤');
                showNotification('–ù–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º', 'error');
                return false;
            }
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π WebSocket
        function handleWebSocketMessage(data) {
            switch (data.type) {
                case 'connected':
                    showNotification(data.message, 'success');
                    break;
                    
                case 'registerSuccess':
                    showNotification(data.message, 'success');
                    showLoginForm();
                    break;
                    
                case 'loginSuccess':
                    currentUser = data.user;
                    deviceId = data.deviceId;
                    sessionId = data.sessionId;
                    showNotification(`–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, ${currentUser.nickname}!`, 'success');
                    showMainMenu();
                    break;

                case 'rooms':
                    updateRoomsList(data.rooms);
                    break;

                case 'roomJoined':
                    currentRoom = data.room;
                    showGameRoom();
                    updateGameRoom();
                    showNotification(`–í—ã –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª–∏—Å—å –∫ –∫–æ–º–Ω–∞—Ç–µ "${currentRoom.name}"`, 'success');
                    break;

                case 'roomUpdated':
                    if (currentRoom) {
                        currentRoom = data.room;
                        updateGameRoom();
                    }
                    break;

                case 'gameStarted':
                    if (currentRoom) {
                        currentRoom = data.room;
                        gameState = currentRoom.game;
                        updateGameRoom();
                        showNotification('üéÆ –ò–≥—Ä–∞ –Ω–∞—á–∞–ª–∞—Å—å!', 'success');
                    }
                    break;

                case 'roleAssigned':
                    showNotification(`üé≠ –í–∞—à–∞ —Ä–æ–ª—å: ${getRoleName(data.role)}`, 'success');
                    if (data.mafiaMembers) {
                        showNotification(`üî´ –ú–∞—Ñ–∏—è: ${data.mafiaMembers.join(', ')}`, 'warning');
                    }
                    break;

                case 'gameUpdate':
                    gameState = data.game;
                    updateGameRoom();
                    
                    if (data.game.lastAction) {
                        showNotification(data.game.lastAction, 'warning');
                    }
                    break;

                case 'gameEnded':
                    showNotification(data.result, 'warning');
                    gameState = null;
                    updateGameRoom();
                    break;

                case 'chatMessage':
                    addChatMessage(data);
                    break;

                case 'stats':
                    updateLobbyStats(data.stats);
                    break;
                    
                case 'error':
                    console.error('–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞:', data.message);
                    showNotification(data.message, 'error');
                    break;
                    
                default:
                    console.log('‚ùì –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø —Å–æ–æ–±—â–µ–Ω–∏—è:', data.type);
            }
        }

        // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —ç–∫—Ä–∞–Ω–∞–º–∏
        function hideAllScreens() {
            const screens = ['loadingScreen', 'authScreen', 'mainMenu', 'gameRoom', 'createRoomForm'];
            screens.forEach(screen => {
                const element = document.getElementById(screen);
                if (element) {
                    element.classList.add('hidden');
                }
            });
        }

        function showAuthScreen() {
            hideAllScreens();
            document.getElementById('authScreen').classList.remove('hidden');
        }

        function showMainMenu() {
            hideAllScreens();
            document.getElementById('mainMenu').classList.remove('hidden');
            updateUserProfile();
            loadRooms();
            sendWebSocketMessage({ type: 'getStats' });
        }

        function showGameRoom() {
            hideAllScreens();
            document.getElementById('gameRoom').classList.remove('hidden');
        }

        // –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
        function showRegisterForm() {
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('registerForm').classList.remove('hidden');
        }

        function showLoginForm() {
            document.getElementById('registerForm').classList.add('hidden');
            document.getElementById('loginForm').classList.remove('hidden');
        }

        function register() {
            const nickname = document.getElementById('registerNickname').value.trim();
            const password = document.getElementById('registerPassword').value;
            const avatar = document.getElementById('registerAvatar').value.trim() || 'üë§';

            if (!nickname || !password) {
                showNotification('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è', 'error');
                return;
            }

            if (nickname.length < 3 || nickname.length > 15) {
                showNotification('–ù–∏–∫–Ω–µ–π–º –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ—Ç 3 –¥–æ 15 —Å–∏–º–≤–æ–ª–æ–≤', 'error');
                return;
            }

            if (password.length < 4 || password.length > 20) {
                showNotification('–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ—Ç 4 –¥–æ 20 —Å–∏–º–≤–æ–ª–æ–≤', 'error');
                return;
            }

            const registerBtn = document.getElementById('registerBtn');
            registerBtn.disabled = true;
            registerBtn.textContent = '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è...';

            const success = sendWebSocketMessage({
                type: 'register',
                nickname: nickname,
                password: password,
                avatar: avatar
            });

            if (!success) {
                registerBtn.disabled = false;
                registerBtn.textContent = '–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è';
            }
        }

        function login() {
            const nickname = document.getElementById('loginNickname').value.trim();
            const password = document.getElementById('loginPassword').value;

            if (!nickname || !password) {
                showNotification('–í–≤–µ–¥–∏—Ç–µ –Ω–∏–∫–Ω–µ–π–º –∏ –ø–∞—Ä–æ–ª—å', 'error');
                return;
            }

            const loginBtn = document.getElementById('loginBtn');
            loginBtn.disabled = true;
            loginBtn.textContent = '–í—Ö–æ–¥...';

            const success = sendWebSocketMessage({
                type: 'login',
                nickname: nickname,
                password: password,
                deviceId: generateDeviceId(),
                userAgent: navigator.userAgent,
                ip: 'unknown'
            });

            if (!success) {
                loginBtn.disabled = false;
                loginBtn.textContent = '–í–æ–π—Ç–∏';
            }
        }

        function logout() {
            currentUser = null;
            currentRoom = null;
            gameState = null;
            showAuthScreen();
            showNotification('–í—ã –≤—ã—à–ª–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã', 'success');
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        function updateUserProfile() {
            if (!currentUser) return;

            const avatarElement = document.getElementById('userAvatar');
            const nicknameElement = document.getElementById('userNickname');
            const coinsElement = document.getElementById('userCoins');
            const gamesPlayedElement = document.getElementById('userGamesPlayed');
            const gamesWonElement = document.getElementById('userGamesWon');

            if (avatarElement) avatarElement.textContent = currentUser.avatar;
            
            if (nicknameElement) {
                nicknameElement.textContent = currentUser.nickname;
                if (currentUser.is_admin) {
                    nicknameElement.innerHTML += '<span class="admin-badge">üëë –ë–û–ì</span>';
                }
            }
            
            if (coinsElement) coinsElement.textContent = `üí∞ ${currentUser.coins} –º–æ–Ω–µ—Ç`;
            if (gamesPlayedElement) gamesPlayedElement.textContent = currentUser.games_played || 0;
            if (gamesWonElement) gamesWonElement.textContent = currentUser.games_won || 0;
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ª–æ–±–±–∏
        function updateLobbyStats(stats) {
            const onlineUsersElement = document.getElementById('onlineUsers');
            const activeRoomsElement = document.getElementById('activeRooms');
            const activeGamesElement = document.getElementById('activeGames');
            const serverUptimeElement = document.getElementById('serverUptime');

            if (onlineUsersElement) onlineUsersElement.textContent = stats.onlineUsers || 0;
            if (activeRoomsElement) activeRoomsElement.textContent = stats.activeRooms || 0;
            if (activeGamesElement) activeGamesElement.textContent = stats.activeGames || 0;
            if (serverUptimeElement) {
                const hours = Math.floor((stats.uptime || 0) / 3600);
                serverUptimeElement.textContent = hours;
            }
        }

        // –ö–æ–º–Ω–∞—Ç—ã
        function loadRooms() {
            sendWebSocketMessage({ type: 'getRooms' });
        }

        function updateRoomsList(rooms) {
            const roomsList = document.getElementById('roomsList');
            if (!roomsList) return;

            if (!rooms || rooms.length === 0) {
                roomsList.innerHTML = '<div style="text-align: center; color: #666; padding: 40px;">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–æ–º–Ω–∞—Ç. –°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—É—é!</div>';
                return;
            }

            roomsList.innerHTML = rooms.map(room => `
                <div class="room-card" onclick="joinRoom('${room.id}')">
                    <div class="room-header">
                        <div class="room-name">${room.name}</div>
                        <div class="room-status ${room.status === 'waiting' ? 'status-waiting' : 'status-playing'}">
                            ${room.status === 'waiting' ? '‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ' : 'üéÆ –ò–≥—Ä–∞—é—Ç'}
                        </div>
                    </div>
                    <div class="room-info">
                        <div class="room-players">üë• ${room.players}/${room.maxPlayers} –∏–≥—Ä–æ–∫–æ–≤</div>
                        <div class="room-creator">üëë ${room.creator}</div>
                        ${room.hasPassword ? '<div style="color: #e74c3c;">üîí –ü—Ä–∏–≤–∞—Ç–Ω–∞—è</div>' : ''}
                    </div>
                    <div style="font-size: 0.8em; color: #999; margin-top: 10px;">
                        –°–æ–∑–¥–∞–Ω–∞: ${new Date(room.createdAt).toLocaleString()}
                    </div>
                </div>
            `).join('');
        }

        function showCreateRoomForm() {
            hideAllScreens();
            document.getElementById('createRoomForm').classList.remove('hidden');
        }

        function hideCreateRoomForm() {
            showMainMenu();
        }

        function createRoom() {
            const name = document.getElementById('roomName').value.trim();
            const password = document.getElementById('roomPassword').value.trim();
            const minPlayers = parseInt(document.getElementById('minPlayers').value);
            const maxPlayers = parseInt(document.getElementById('maxPlayers').value);
            const doctorRole = document.getElementById('doctorRole').checked;
            const loversRole = document.getElementById('loversRole').checked;

            if (!name) {
                showNotification('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–Ω–∞—Ç—ã', 'error');
                return;
            }

            if (name.length > 30) {
                showNotification('–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–Ω–∞—Ç—ã —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–æ–µ', 'error');
                return;
            }

            if (minPlayers >= maxPlayers) {
                showNotification('–ú–∞–∫—Å–∏–º—É–º –∏–≥—Ä–æ–∫–æ–≤ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –±–æ–ª—å—à–µ –º–∏–Ω–∏–º—É–º–∞', 'error');
                return;
            }

            const roomData = {
                name: name,
                password: password || null,
                minPlayers: minPlayers,
                maxPlayers: maxPlayers,
                roles: {
                    doctor: doctorRole,
                    don: true,
                    lovers: loversRole
                }
            };

            sendWebSocketMessage({
                type: 'createRoom',
                room: roomData
            });
        }

        function joinRoom(roomId) {
            const password = prompt('–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å (–µ—Å–ª–∏ –∫–æ–º–Ω–∞—Ç–∞ –ø—Ä–∏–≤–∞—Ç–Ω–∞—è):');
            
            sendWebSocketMessage({
                type: 'joinRoom',
                roomId: roomId,
                password: password
            });
        }

        function leaveRoom() {
            sendWebSocketMessage({ type: 'leaveRoom' });
            
            currentRoom = null;
            gameState = null;
            showMainMenu();
        }

        // –ò–≥—Ä–æ–≤–∞—è –∫–æ–º–Ω–∞—Ç–∞
        function updateGameRoom() {
            if (!currentRoom) return;

            updatePlayersGrid();
            updateGameHeader();
            updateGameActions();
            updateStartGameButton();
        }

        function updateStartGameButton() {
            const existingButton = document.getElementById('startGameButton');
            if (existingButton) {
                existingButton.remove();
            }
            
            if (!currentRoom || currentRoom.status !== 'waiting') return;
            
            const currentPlayer = currentRoom.players.find(p => p.nickname === currentUser.nickname);
            if (!currentPlayer || !currentPlayer.isCreator) return;
            
            if (currentRoom.players.length < currentRoom.minPlayers) return;
            
            const gameMain = document.querySelector('.game-main');
            const startButton = document.createElement('div');
            startButton.id = 'startGameButton';
            startButton.className = 'card';
            startButton.style.textAlign = 'center';
            startButton.innerHTML = `
                <h3 style="color: #667eea; margin-bottom: 15px;">üéÆ –ì–æ—Ç–æ–≤—ã –Ω–∞—á–∞—Ç—å?</h3>
                <p style="margin-bottom: 15px;">–ò–≥—Ä–æ–∫–æ–≤: ${currentRoom.players.length}/${currentRoom.maxPlayers}</p>
                <button class="btn btn-success" onclick="startGame()" style="font-size: 1.2em; padding: 15px 30px;">
                    üöÄ –ù–ê–ß–ê–¢–¨ –ò–ì–†–£
                </button>
            `;
            
            gameMain.appendChild(startButton);
        }

        function updatePlayersGrid() {
            const playersGrid = document.getElementById('playersGrid');
            if (!playersGrid || !currentRoom) return;

            playersGrid.innerHTML = currentRoom.players.map(player => {
                const isSelected = selectedPlayer === player.nickname;
                const isDead = !player.isAlive;
                
                return `
                    <div class="player-card ${isDead ? 'dead' : ''} ${isSelected ? 'selected' : ''}" 
                         onclick="selectPlayer('${player.nickname}')">
                        <div class="player-avatar">${player.avatar}</div>
                        <div class="player-nickname">${player.nickname}</div>
                        ${player.isCreator ? '<div style="color: #f39c12;">üëë –°–æ–∑–¥–∞—Ç–µ–ª—å</div>' : ''}
                        ${player.isBot ? '<div style="color: #95a5a6;">ü§ñ –ë–æ—Ç</div>' : ''}
                        ${player.role ? `<div class="player-role">${getRoleName(player.role)}</div>` : ''}
                        <div class="player-status ${player.isAlive ? 'status-alive' : 'status-dead'}">
                            ${player.isAlive ? 'üíö –ñ–∏–≤' : 'üíÄ –ú—ë—Ä—Ç–≤'}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateGameHeader() {
            const gamePhaseElement = document.getElementById('gamePhase');
            const gameTimerElement = document.getElementById('gameTimer');
            const gameRoleElement = document.getElementById('gameRole');

            if (!gamePhaseElement || !gameTimerElement || !gameRoleElement) return;

            if (currentRoom.status === 'waiting') {
                gamePhaseElement.textContent = `–û–∂–∏–¥–∞–Ω–∏–µ –∏–≥—Ä–æ–∫–æ–≤ (${currentRoom.players.length}/${currentRoom.maxPlayers})`;
                gameTimerElement.textContent = '--:--';
                gameRoleElement.textContent = '';
            } else if (currentRoom.status === 'playing' && gameState) {
                gamePhaseElement.textContent = `${getPhaseNameRu(gameState.phase)} - –î–µ–Ω—å ${gameState.day}`;
                
                if (gameState.timeLeft) {
                    const minutes = Math.floor(gameState.timeLeft / 60);
                    const seconds = gameState.timeLeft % 60;
                    gameTimerElement.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                } else {
                    gameTimerElement.textContent = '--:--';
                }

                const currentPlayer = currentRoom.players.find(p => p.nickname === currentUser.nickname);
                if (currentPlayer && currentPlayer.role) {
                    gameRoleElement.textContent = `–í–∞—à–∞ —Ä–æ–ª—å: ${getRoleName(currentPlayer.role)}`;
                }

                if (gameState.votingResults && Object.keys(gameState.votingResults).length > 0) {
                    const votingHtml = Object.entries(gameState.votingResults)
                        .sort(([,a], [,b]) => b - a)
                        .map(([player, votes]) => `${player}: ${votes} –≥–æ–ª–æ—Å(–æ–≤)`)
                        .join('<br>');
                    gameRoleElement.innerHTML += `<br><div style="color: #f39c12; margin-top: 10px;">üó≥Ô∏è –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è:<br>${votingHtml}</div>`;
                }
            }
        }

        function updateGameActions() {
            const gameActions = document.getElementById('gameActions');
            if (!gameActions || !currentRoom || !gameState) {
                gameActions?.classList.add('hidden');
                return;
            }

            const currentPlayer = currentRoom.players.find(p => p.nickname === currentUser.nickname);
            if (!currentPlayer || !currentPlayer.isAlive) {
                gameActions.classList.add('hidden');
                return;
            }

            const actionTitle = document.getElementById('actionTitle');
            const actionButtons = document.getElementById('actionButtons');
            
            let showActions = false;
            let title = '';
            let buttons = '';

            if (gameState.phase === 'night') {
                if (currentPlayer.role === 'mafia' || currentPlayer.role === 'don') {
                    showActions = true;
                    title = 'üî´ –í—ã–±–µ—Ä–∏—Ç–µ —Ü–µ–ª—å –¥–ª—è —É–±–∏–π—Å—Ç–≤–∞:';
                    buttons = currentRoom.players
                        .filter(p => p.isAlive && p.nickname !== currentUser.nickname && !['mafia', 'don'].includes(p.role))
                        .map(p => `<button class="btn btn-danger" onclick="makeGameAction('kill', '${p.nickname}')">${p.avatar} ${p.nickname}</button>`)
                        .join('');
                } else if (currentPlayer.role === 'doctor') {
                    showActions = true;
                    title = 'üë®‚Äç‚öïÔ∏è –í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–≥–æ –ª–µ—á–∏—Ç—å:';
                    buttons = currentRoom.players
                        .filter(p => p.isAlive)
                        .map(p => `<button class="btn btn-success" onclick="makeGameAction('heal', '${p.nickname}')">${p.avatar} ${p.nickname}</button>`)
                        .join('');
                }
            } else if (gameState.phase === 'day') {
                showActions = true;
                title = 'üó≥Ô∏è –ì–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ - –≤—ã–±–µ—Ä–∏—Ç–µ –∫–æ–≥–æ –∏—Å–∫–ª—é—á–∏—Ç—å:';
                buttons = currentRoom.players
                    .filter(p => p.isAlive)
                    .map(p => `<button class="btn ${p.nickname === currentUser.nickname ? 'btn-secondary' : ''}" onclick="makeGameAction('vote', '${p.nickname}')">${p.avatar} ${p.nickname}</button>`)
                    .join('');
                buttons += '<button class="btn btn-secondary" onclick="makeGameAction(\'vote\', null)">–í–æ–∑–¥–µ—Ä–∂–∞—Ç—å—Å—è</button>';
            }

            if (showActions) {
                actionTitle.textContent = title;
                actionButtons.innerHTML = buttons;
                gameActions.classList.remove('hidden');
            } else {
                gameActions.classList.add('hidden');
            }
        }

        function makeGameAction(action, target) {
            console.log(`üéÆ –ò–≥—Ä–æ–≤–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ: ${action} -> ${target}`);
            
            sendWebSocketMessage({
                type: 'gameAction',
                action: {
                    action: action,
                    target: target
                }
            });
            
            const actionName = {
                'kill': '—É–±–∏–π—Å—Ç–≤–æ',
                'heal': '–ª–µ—á–µ–Ω–∏–µ', 
                'vote': '–≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ'
            }[action] || action;
            
            showNotification(`${actionName.charAt(0).toUpperCase() + actionName.slice(1)} –≤—ã–ø–æ–ª–Ω–µ–Ω–æ`, 'success');
            updateGameActions();
        }

        function selectPlayer(nickname) {
            selectedPlayer = selectedPlayer === nickname ? null : nickname;
            updatePlayersGrid();
        }

        function startGame() {
            sendWebSocketMessage({ type: 'startGame' });
        }

        // –ß–∞—Ç
        function addChatMessage(data) {
            const chatMessages = document.getElementById('chatMessages');
            if (!chatMessages) return;

            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${data.sender === '–°–∏—Å—Ç–µ–º–∞' ? 'system' : ''}`;
            
            const time = new Date(data.timestamp).toLocaleTimeString();
            messageDiv.innerHTML = `
                <span class="message-sender">${data.sender}:</span>
                ${data.message}
                <span class="message-time">${time}</span>
            `;

            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function sendMessage() {
            const chatInput = document.getElementById('chatInput');
            if (!chatInput || !chatInput.value.trim()) return;

            const message = chatInput.value.trim();
            if (message.length > 200) {
                showNotification('–°–æ–æ–±—â–µ–Ω–∏–µ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–æ–µ (–º–∞–∫—Å–∏–º—É–º 200 —Å–∏–º–≤–æ–ª–æ–≤)', 'error');
                return;
            }

            sendWebSocketMessage({
                type: 'chatMessage',
                message: message
            });

            chatInput.value = '';
        }

        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
        function getRoleName(role) {
            const roleNames = {
                'citizen': 'üë®‚Äçüíº –ú–∏—Ä–Ω—ã–π –∂–∏—Ç–µ–ª—å',
                'mafia': 'üî´ –ú–∞—Ñ–∏—è',
                'don': 'üëë –î–æ–Ω –º–∞—Ñ–∏–∏',
                'doctor': 'üë®‚Äç‚öïÔ∏è –î–æ–∫—Ç–æ—Ä',
                'lover1': 'üíï –í–ª—é–±–ª—ë–Ω–Ω—ã–π',
                'lover2': 'üíï –í–ª—é–±–ª—ë–Ω–Ω–∞—è'
            };
            return roleNames[role] || role;
        }

        function getPhaseNameRu(phase) {
            const phaseNames = {
                'night': 'üåô –ù–æ—á—å',
                'day': '‚òÄÔ∏è –î–µ–Ω—å',
                'voting': 'üó≥Ô∏è –ì–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ',
                'lastWords': 'üí¨ –ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å–ª–æ–≤–∞'
            };
            return phaseNames[phase] || phase;
        }

        // –ó–∞–≥–ª—É—à–∫–∏ –¥–ª—è —Ñ—É–Ω–∫—Ü–∏–π
        function showShop() {
            showNotification('–ú–∞–≥–∞–∑–∏–Ω –ø–æ–∫–∞ –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω', 'warning');
        }

        function showSettings() {
            showNotification('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–∫–∞ –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã', 'warning');
        }

        // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
        function showNotification(message, type = 'info') {
            const existingNotifications = document.querySelectorAll('.notification');
            existingNotifications.forEach(notification => notification.remove());

            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;

            document.body.appendChild(notification);

            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 5000);

            console.log(`üì¢ ${type.toUpperCase()}: ${message}`);
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
        function setupEventListeners() {
            // Enter –¥–ª—è –ª–æ–≥–∏–Ω–∞
            const loginNickname = document.getElementById('login Nickname');
            const loginPassword = document.getElementById('loginPassword');
            const chatInput = document.getElementById('chatInput');
            
            if (loginNickname) {
                loginNickname.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        login();
                    }
                });
            }

            if (loginPassword) {
                loginPassword.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        login();
                    }
                });
            }

            if (chatInput) {
                chatInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        sendMessage();
                    }
                });
            }

            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ—Ç–µ—Ä–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
            window.addEventListener('online', function() {
                console.log('üåê –ò–Ω—Ç–µ—Ä–Ω–µ—Ç –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω');
                if (connectionStatus !== 'connected') {
                    forceReconnect();
                }
            });

            window.addEventListener('offline', function() {
                console.log('üåê –ò–Ω—Ç–µ—Ä–Ω–µ—Ç –æ—Ç–∫–ª—é—á–µ–Ω');
                updateConnectionStatus('disconnected', '–ù–µ—Ç –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞');
            });
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è');
            console.log('üåê URL:', window.location.href);
            console.log('üîó Host:', window.location.host);
            console.log('üîí Protocol:', window.location.protocol);
            
            setupEventListeners();
            
            // –ó–∞–ø—É—Å–∫–∞–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —á–µ—Ä–µ–∑ –Ω–µ–±–æ–ª—å—à—É—é –∑–∞–¥–µ—Ä–∂–∫—É
            setTimeout(() => {
                connectWebSocket();
            }, 500);
        });

        // –û—Ç–∫–ª—é—á–µ–Ω–∏–µ pull-to-refresh
        document.addEventListener('touchstart', function(e) {
            if (e.touches.length > 1) {
                e.preventDefault();
            }
        }, { passive: false });

        document.addEventListener('touchmove', function(e) {
            if (window.scrollY === 0 && e.touches[0].clientY > e.touches[0].pageY) {
                e.preventDefault();
            }
        }, { passive: false });

        document.addEventListener('contextmenu', function(e) {
            e.preventDefault();
        });
    </script>
</body>
</html>
